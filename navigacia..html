<!DOCTYPE html>
<html>
<head>
 <style type="text/css">
    html, body{
    height: 100%;
    width: 100%;
}
   </style>
</head>
<body>

<div id="map" style="width:100%;height:95%"></div>

<button onclick="stop()">stop</button>
<button onclick="">load</button>

<script src="math.js"></script>
<script src="kalman.js"> </script>
<script>
var rate = 0.2
;
var pnoise = 0.1
;
var mnoise =0.4;
var kalmanError = [];
var gpsError = [];
var kalmanAvg = 0;
var gpsAvg = 0
var kalmanX = new KalmanFilter(rate,pnoise,mnoise);
 var kalmanY = new KalmanFilter(rate,pnoise,mnoise);

var id;
var poly
var service
var markers=[]
function point (x,y,speed,heading,accuracy,time,filtrovany) {
    this.x = x;
    this.y = y;
    this.speed = speed
    this.heading = heading
    this.accuracy = accuracy
    this.time=time
    this.filtrovany=filtrovany
}
  point.prototype.set_x= function(x) { this.x=x }
  point.prototype.set_y= function(y) { this.y=y }
  point.prototype.set_accuracy= function(accuracy) { this.accuracy=accuracy }
  point.prototype.set_time= function(time) { this.time=time }
var suradnice=[]
var nefiltrovanesuradnice=[]
var lat_lng = new Array();
var destinationmarker=null
var latarr=[] 
var lonarr=[]
options = {
  enableHighAccuracy: true,
  timeout: 1000,
  maximumAge: 0
};
function getLocation(map) {
     if((navigator.geolocation)){
        id = navigator.geolocation.watchPosition(function(position){
            
            showPosition(map,position)
	    , {options}     	
	
    },function error(msg){alert('Please enable your GPS position future.');  
  })
  }else { 
    	
    }
    
   
}
function addposition(position,suradnice, filtrovany){
    
 suradnice.push(new point(position.coords.latitude,position.coords.longitude,position.coords.speed,position.coords.heading,position.coords.accuracy,position.timestamp, filtrovany));
}
function set_destination_Marker(map, location) {
   remove_marker_from_map(destinationmarker)
   destinationmarker= new google.maps.Marker({
    position: location,
    map: map
  });
  drawroute(map)
}
function toRad(value) {
      var RADIANT_CONSTANT = 0.0174532925199433;
      return (value * RADIANT_CONSTANT);
    }

function calculateSpeed(t1, lat1, lon1, t2, lat2, lon2) {
  var d = Math.sqrt(Math.pow(lat2-lat1,2)+Math.pow(lon2-lon1,2))*1000
  console.log(d)
  return (d/((t2-t1)*0.01))*3600;
}



function drawroute(map){
if (poly!=null || poly!=undefined){
poly.setMap(null)
}
var path = new google.maps.MVCArray();
           service = new google.maps.DirectionsService();
           
          
           poly = new google.maps.Polyline({ map: map, strokeColor: '#FF8200' });
           var lat_lng = new Array();
            var myLatlng = new google.maps.LatLng(suradnice[suradnice.length-1].x, suradnice[suradnice.length-1].y);
            lat_lng.push(myLatlng);
           var myLatlng = new google.maps.LatLng(destinationmarker.position.lat(),destinationmarker.position.lng());
            lat_lng.push(myLatlng);
           for (var i = 0; i < lat_lng.length; i++) {
               if ((i + 1) < lat_lng.length) {
                   var src = lat_lng[i];
                   var des = lat_lng[i + 1];
                   path.push(src);
                   poly.setPath(path);
                   service.route({
                       origin: src,
                       destination: des,
                       travelMode: google.maps.DirectionsTravelMode.WALKING
                   }, function (result, status) {
                       if (status == google.maps.DirectionsStatus.OK) {
                           for (var i = 0, len = result.routes[0].overview_path.length; i < len; i++) {
                               path.push(result.routes[0].overview_path[i]);
                           }
                       }
                   });
               }
           }
}
      
function drawpath(map,s,i1,i2){
    
var curr=new google.maps.LatLng(Number(s[i1].x),Number(s[i1].y));
var dest=new google.maps.LatLng(Number(s[i2].x),Number(s[i2].y));

var color="#0000FF"
if (s[s.length-1].speed>=10){
color='green'
}
var flightPath = new google.maps.Polyline({
    path: [curr, dest],
    strokeColor: color,
    strokeOpacity: 0.8,
    strokeWeight: 2
      
  })
    flightPath.setMap(map);
}
function addmarker(map){
     var myCenter = new        google.maps.LatLng(suradnice[suradnice.length-1].x,suradnice[suradnice.length-1].y);
  markers.push(new google.maps.Marker({position:myCenter}));
  markers[markers.length-1].setMap(map);
}
function changespeed(){

var speed=calculateSpeed(suradnice[suradnice.length-2].time, suradnice[suradnice.length-2].x, suradnice[suradnice.length-2].y, suradnice[suradnice.length-1].time, suradnice[suradnice.length-1].x, suradnice[suradnice.length-1].y) 
 suradnice[suradnice.length-2].speed=speed
 suradnice[suradnice.length-1].speed=speed
if (speed>10){
changemarkercolor(markers.length-1)
changemarkercolor(markers.length-2)
}
}
function destinationreached(){
    
    if (suradnice[suradnice.length-1]!==undefined && suradnice[suradnice.length-1]!==null){
currchoords=new google.maps.LatLng(suradnice[suradnice.length-1].x,suradnice[suradnice.length-1].y)
 destchoords=new google.maps.LatLng(destinationmarker.position.lat(),destinationmarker.position.lng())
 
 if(google.maps.geometry.spherical
   .computeDistanceBetween(currchoords,destchoords)<50){
  alert('ste na mieste!'
  ); 
 stop()
   }
}
} 
function changemarkercolor(index){
markers[index].setIcon('https://maps.google.com/mapfiles/ms/icons/green-dot.png'
)
}
function showPosition(map,position) {
if (suradnice.length>=1){
var myCenter = new        google.maps.LatLng(position.coords.latitude,position.coords.longitude);
  var marker= new google.maps.Marker({position:myCenter});
  marker.setMap(map);
  marker.setIcon('https://maps.google.com/mapfiles/ms/icons/green-dot.png'
)


}
addposition(position,nefiltrovanesuradnice,1)
addposition(position,suradnice,0)   
var filteredx= kalmanX.update(suradnice[suradnice.length-1].x);
var filteredy= kalmanY.update(suradnice[suradnice.length-1].y);
    suradnice[suradnice.length-1].x=filteredx[0]
    suradnice[suradnice.length-1].y=filteredy[0]
    

addmarker(map)


  
  
var curr_Latlng = new 
google.maps.LatLng(position.coords.latitude,position.coords.longitude);
                lat_lng.push(curr_Latlng );
if (suradnice.length>1){
 changespeed()
 drawpath(map,suradnice,suradnice.length-2,suradnice.length-1)
}
if (destinationmarker!==null){
drawroute(map)

destinationreached()
} 
}
function remove_marker_from_map(marker){
 if (marker!=null){
  marker.setMap(null);
 }
}
function myMap() {
  
  var myCenter = new        google.maps.LatLng(48.147948, 17.107377);
  
  var mapCanvas = document.getElementById("map");
  var mapOptions = {center: myCenter, zoom: 13};
  var map = new google.maps.Map(mapCanvas, mapOptions);
  service = new google.maps.DirectionsService()
  load(map)
  getLocation(map)
  google.maps.event.addListener(map, 'click', function(event) {
    set_destination_Marker(map, event.latLng);
  });
}
function save_coordinates(){
  var tmp = {"suradnice":suradnice,
              "nefiltrovanesuradnice":nefiltrovanesuradnice}
              console.log(nefiltrovanesuradnice,suradnice)
        tmp=JSON.stringify(tmp)
  console.log(tmp)
 
  $.ajax({
    type: 'POST',
    url: 'save_coordinates.php',
    data: {'coordinates': tmp},
    success: function(msg) {
     
    }
  });
}
function load(map) {
    filtrovane=[]
    var kalmanX1 = new KalmanFilter(rate,pnoise,mnoise);
 var kalmanY1 = new KalmanFilter(rate,pnoise,mnoise);
        console.log(map)
        $.ajax({ 
            type: "GET",
            url: "load_choords.php",
            dataType: "json",                 
            success: function (response) {
             
                for(var i=0;i<response.length-2;i++){
                    console.log(response[i])
                    drawpath(map,response,i,i+1)
                    var filteredx= kalmanX1.update(Number(response[i].x));
                     var filteredy= kalmanY1.update(Number(response[i].y));
                     var filteredx1= kalmanX1.update(Number(response[i+1].x));
                     var filteredy1= kalmanY1.update(Number(response[i+1].y));
                  var speed= calculateSpeed(Number(response[i].time), filteredx, filteredy, Number(response[i+1].time), filteredx1, filteredy1)
                   // console.log(filteredx,response[i].x)
                   
                     var myCenter = new        google.maps.LatLng(filteredx,filteredy);
                     var m=new google.maps.Marker({position:myCenter});
                     m.setMap(map);
                     if(speed>10){
                         m.setIcon('https://maps.google.com/mapfiles/ms/icons/green-dot.png'
)
                     }
                    var myCenter = new        google.maps.LatLng(filteredx1,filteredy1);
                     var m=new google.maps.Marker({position:myCenter});
                     m.setMap(map);
                     if(speed>10){
                         m.setIcon('https://maps.google.com/mapfiles/ms/icons/green-dot.png'
)
                     }
    
                }
                for(var i=0;i<filtrovane.length-2;i++){
                    
                    drawpath(map,filtrovane,i,i+1)
                    
    
                }
            }
        });
    };
function stop(){
	navigator.geolocation.clearWatch(id);
  save_coordinates()
  navigator.geolocation.clearWatch(id);
   
}



</script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxMnshqKql7s93txpzieTVSVUFfopd2Ww&callback=myMap"></script>


</body>
</html>
